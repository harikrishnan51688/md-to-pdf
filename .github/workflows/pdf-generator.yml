name: Generate PDF from Markdown

on:
  push:
    paths:
      - 'doc/**/*.md'
    branches: [main, master]
  
  workflow_dispatch:
    inputs:
      generation_scope:
        description: 'Generation scope'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - specific
      specific_files:
        description: 'Specific files (comma-separated, e.g., doc/guide.md)'
        required: false
        type: string

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended
        pip install PyPDF2 reportlab
    
    - name: ðŸ” Detect files and get commit author
      id: detect
      run: |
        mkdir -p generated-pdfs
        
        echo "Event: ${{ github.event_name }}"
        
        # Get the actual last commit author who modified any .md file
        if [ "${{ github.event_name }}" == "push" ]; then
          # Find the most recent commit that touched any .md file in doc/
          # Format: "hash author_name file1 file2..."
          LAST_MD_INFO=$(git log --name-only --pretty=format:"%h %an" -- doc/**/*.md 2>/dev/null | head -1)
          LAST_MD_COMMIT=$(echo "$LAST_MD_INFO" | cut -d' ' -f1)
          COMMIT_AUTHOR=$(echo "$LAST_MD_INFO" | cut -d' ' -f2)
          
          # Fallback if no .md history
          if [ -z "$COMMIT_AUTHOR" ]; then
            COMMIT_AUTHOR="${{ github.actor }}"
            echo "No .md commit history found, using actor: $COMMIT_AUTHOR"
          else
            echo "Found last .md commit: $LAST_MD_COMMIT by $COMMIT_AUTHOR"
          fi
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
        else
          # For manual triggers, use the actor who triggered it
          echo "Manual trigger by: ${{ github.actor }}"
          echo "commit_author=${{ github.actor }}" >> $GITHUB_OUTPUT
        fi
        
        # Detect files to process
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          SCOPE="${{ github.event.inputs.generation_scope }}"
          SPECIFIC="${{ github.event.inputs.specific_files }}"
          
          if [ "$SCOPE" == "all" ]; then
            echo "Manual trigger: ALL files"
            FILES=$(find doc -name "*.md" -type f 2>/dev/null || echo "")
          elif [ "$SCOPE" == "specific" ] && [ -n "$SPECIFIC" ]; then
            echo "Manual trigger: SPECIFIC files"
            FILES=$(echo "$SPECIFIC" | tr ',' '\n')
          else
            echo "Invalid manual trigger options"
            FILES=""
          fi
        else
          echo "Push event: Checking for changed .md files"
          # Handle first commit case
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD~1 HEAD -- 'doc/*.md' 'doc/**/*.md' 2>/dev/null || echo "")
          else
            echo "First commit detected - processing all files"
            FILES=$(find doc -name "*.md" -type f 2>/dev/null || echo "")
          fi
        fi
        
        # Debug: Show raw files found
        echo "Raw files found:"
        echo "$FILES"
        
        # Convert to JSON array
        JSON_FILES="["
        FIRST=true
        while IFS= read -r file; do
          file=$(echo "$file" | xargs)
          if [ -n "$file" ] && [ -f "$file" ]; then
            echo "Valid file: $file"
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON_FILES="$JSON_FILES,"
            fi
            JSON_FILES="$JSON_FILES\"$file\""
          fi
        done <<< "$FILES"
        JSON_FILES="$JSON_FILES]"
        
        echo "Final JSON: $JSON_FILES"
        echo "files=$JSON_FILES" >> $GITHUB_OUTPUT
    
    - name: ðŸ–¨ï¸ Generate PDFs
      if: steps.detect.outputs.files != '[]'
      id: generate
      env:
        FILES_JSON: ${{ steps.detect.outputs.files }}
        COMMIT_AUTHOR: ${{ steps.detect.outputs.commit_author }}
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        WATERMARK="Generated by $COMMIT_AUTHOR on $TIMESTAMP"
        
        echo "Watermark: $WATERMARK"
        echo "Files JSON: $FILES_JSON"
        
        python3 scripts/generate_pdfs.py "$FILES_JSON" "$WATERMARK"
        
        COUNT=$(find generated-pdfs -name "*.pdf" -type f 2>/dev/null | wc -l)
        echo "pdf_count=$COUNT" >> $GITHUB_OUTPUT
    
    - name: ðŸ’¾ Commit generated PDFs
      if: steps.generate.outputs.pdf_count != '0'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add generated-pdfs/
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MSG="ðŸ“„ Manual PDF generation"
        else
          MSG="ðŸ¤– Auto-generated PDF from markdown changes"
        fi
        
        COMMIT_AUTHOR="${{ steps.detect.outputs.commit_author }}"
        MSG="$MSG by $COMMIT_AUTHOR - ${{ steps.generate.outputs.pdf_count }} file(s)"
        
        git commit -m "$MSG [skip ci]" || echo "No changes"
        git push
