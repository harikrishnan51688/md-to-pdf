name: Generate PDFs from Markdown

on:
  # Automatic trigger when .md files change in doc/
  push:
    paths:
      - 'doc/**/*.md'
    branches: [main, master]
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      generation_scope:
        description: 'Generation scope'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - specific
      specific_files:
        description: 'Specific files (comma-separated, e.g., doc/guide.md,doc/api.md)'
        required: false
        type: string
      watermark_text:
        description: 'Custom watermark (optional)'
        required: false
        type: string

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for git diff
    
    - name: Setup Python environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended
        
    - name: Install Python packages
      run: pip install PyPDF2 reportlab
    
    - name: Detect files to process
      id: file-detector
      run: |
        python scripts/detect_changed_files.py
        
    - name: Generate PDFs with watermarks
      id: pdf-generator
      env:
        FILES_JSON: ${{ steps.file-detector.outputs.files }}
        WATERMARK_TEXT: ${{ github.event.inputs.watermark_text || '' }}
      run: |
        python scripts/generate_pdfs.py "$FILES_JSON"
        
    - name: Commit generated PDFs
      if: steps.pdf-generator.outputs.pdf_count != '0'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add PDFs to git
        git add generated-pdfs/*.pdf
        
        # Create commit message
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MSG="ðŸ“„ Manual PDF generation: ${{ steps.pdf-generator.outputs.pdf_count }} file(s)"
        else
          MSG="ðŸ¤– Auto-generated PDF(s) from markdown changes"
        fi
        
        git commit -m "$MSG [skip ci]" || echo "No changes to commit"
        git push
