name: Generate PDF from Markdown

on:
  push:
    paths:
      - 'doc/**/*.md'
    branches: [main, master]
  
  workflow_dispatch:
    inputs:
      generation_scope:
        description: 'Generation scope'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - specific
      specific_files:
        description: 'Specific files (comma-separated, e.g., doc/guide.md)'
        required: false
        type: string

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name:  Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name:  Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name:  Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended
        pip install PyPDF2 reportlab
    
    - name:  Detect files and get REAL commit author
      id: detect
      run: |
        mkdir -p generated-pdfs
        
        echo "Event: ${{ github.event_name }}"
        
        # Get the actual last commit author who modified any .md file (FIXED)
        if [ "${{ github.event_name }}" == "push" ]; then
          # FIX: Use proper git log format and quoted pathspec
          # %an = author name, %H = full hash
          LAST_MD_COMMIT=$(git log -1 --pretty=format:"%H" -- 'doc/*.md' 'doc/**/*.md' 2>/dev/null)
          
          if [ -n "$LAST_MD_COMMIT" ]; then
            COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" "$LAST_MD_COMMIT")
            echo "Found last .md commit: $LAST_MD_COMMIT by $COMMIT_AUTHOR"
          else
            # Fallback: get author of current commit
            COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
            echo "No .md history, using current commit author: $COMMIT_AUTHOR"
          fi
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
        else
          # For manual triggers, use the actor who triggered it
          echo "Manual trigger by: ${{ github.actor }}"
          echo "commit_author=${{ github.actor }}" >> $GITHUB_OUTPUT
        fi
        
        # Detect files to process
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          SCOPE="${{ github.event.inputs.generation_scope }}"
          SPECIFIC="${{ github.event.inputs.specific_files }}"
          
          if [ "$SCOPE" == "all" ]; then
            echo "Manual trigger: ALL files"
            FILES=$(find doc -name "*.md" -type f 2>/dev/null || echo "")
          elif [ "$SCOPE" == "specific" ] && [ -n "$SPECIFIC" ]; then
            echo "Manual trigger: SPECIFIC files"
            FILES=$(echo "$SPECIFIC" | tr ',' '\n')
          else
            echo "Invalid manual trigger options"
            FILES=""
          fi
        else
          echo "Push event: Checking for changed .md files"
          # Handle first commit case
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD~1 HEAD -- 'doc/*.md' 'doc/**/*.md' 2>/dev/null || echo "")
          else
            echo "First commit detected - processing all files"
            FILES=$(find doc -name "*.md" -type f 2>/dev/null || echo "")
          fi
        fi
        
        # Debug: Show raw files found
        echo "Raw files found:"
        echo "$FILES"
        
        # Convert to JSON array
        JSON_FILES="["
        FIRST=true
        while IFS= read -r file; do
          file=$(echo "$file" | xargs)
          if [ -n "$file" ] && [ -f "$file" ]; then
            echo "Valid file: $file"
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON_FILES="$JSON_FILES,"
            fi
            JSON_FILES="$JSON_FILES\"$file\""
          fi
        done <<< "$FILES"
        JSON_FILES="$JSON_FILES]"
        
        echo "Final JSON: $JSON_FILES"
        echo "files=$JSON_FILES" >> $GITHUB_OUTPUT
    
    - name:  Generate PDFs
      if: steps.detect.outputs.files != '[]'
      id: generate
      env:
        FILES_JSON: ${{ steps.detect.outputs.files }}
        COMMIT_AUTHOR: ${{ steps.detect.outputs.commit_author }}
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        WATERMARK="Generated by $COMMIT_AUTHOR on $TIMESTAMP"
        
        echo "Watermark: $WATERMARK"
        echo "Files JSON: $FILES_JSON"
        
        python3 scripts/generate_pdfs.py "$FILES_JSON" "$WATERMARK"
        
        COUNT=$(find generated-pdfs -name "*.pdf" -type f 2>/dev/null | wc -l)
        echo "pdf_count=$COUNT" >> $GITHUB_OUTPUT
    
    - name:  Commit generated PDFs
      if: steps.generate.outputs.pdf_count != '0'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add generated-pdfs/
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MSG=" Manual PDF generation"
        else
          MSG=" Auto-generated PDF from markdown changes"
        fi
        
        COMMIT_AUTHOR="${{ steps.detect.outputs.commit_author }}"
        MSG="$MSG by $COMMIT_AUTHOR - ${{ steps.generate.outputs.pdf_count }} file(s)"
        
        git commit -m "$MSG [skip ci]" || echo "No changes"
        git push
