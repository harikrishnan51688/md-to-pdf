name: Simple PDF Generator

on:
  push:
    paths: ['doc/**/*.md']
    branches: [main]
  
  workflow_dispatch:
    inputs:
      generate_all:
        description: 'Generate all PDFs?'
        required: false
        default: false
        type: boolean

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Setup
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended
        pip install PyPDF2 reportlab
    
    - name: Find files to process
      id: find_files
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.generate_all }}" == "true" ]]; then
          # Manual trigger - all files
          FILES=$(find doc -name "*.md" -type f)
        else
          # Push event - changed files only
          FILES=$(git diff --name-only HEAD~1 HEAD -- 'doc/**/*.md' 2>/dev/null || echo "")
        fi
        
        if [ -z "$FILES" ]; then
          echo "No files to process"
          echo "files=" >> $GITHUB_OUTPUT
          echo "file_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "$FILES" > /tmp/files.txt
        echo "files=$FILES" >> $GITHUB_OUTPUT
        echo "file_count=$(echo "$FILES" | wc -l)" >> $GITHUB_OUTPUT
    
    - name: Generate PDFs
      if: steps.find_files.outputs.file_count != '0'
      run: |
        TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
        ACTOR="${{ github.actor }}"
        
        while read md_file; do
          if [ -f "$md_file" ]; then
            echo "Processing: $md_file"
            pdf_file="${md_file%.md}.pdf"
            
            # Generate PDF
            pandoc "$md_file" -o "$pdf_file" --pdf-engine=xelatex
            
            # Simple watermark using Python
            python3 -c "
from PyPDF2 import PdfReader, PdfWriter
from reportlab.pdfgen import canvas
from io import BytesIO
import sys

input_pdf = sys.argv[1]
output_pdf = sys.argv[2]
watermark_text = sys.argv[3]

reader = PdfReader(input_pdf)
writer = PdfWriter()

for page in reader.pages:
    packet = BytesIO()
    can = canvas.Canvas(packet, pagesize=(600, 800))
    can.setFont('Helvetica', 20)
    can.setFillColorRGB(0.5, 0.5, 0.5, alpha=0.3)
    can.drawString(50, 50, watermark_text)
    can.save()
    
    packet.seek(0)
    from PyPDF2 import PdfReader as WatermarkReader
    watermark = WatermarkReader(packet)
    page.merge_page(watermark.pages[0])
    writer.add_page(page)

with open(output_pdf, 'wb') as f:
    writer.write(f)
            " "$pdf_file" "$pdf_file" "Generated by $ACTOR on $TIMESTAMP"
            
            echo "Generated: $pdf_file"
          fi
        done < /tmp/files.txt
    
    - name: Commit PDFs
      if: steps.find_files.outputs.file_count != '0'
      run: |
        git config user.email "github-actions@example.com"
        git config user.name "GitHub Actions"
        git add doc/**/*.pdf
        git commit -m "Generated PDFs [skip ci]" || echo "No changes"
        git push
