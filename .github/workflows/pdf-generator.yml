name: Generate PDFs from Markdown

on:
  push:
    paths:
      - 'doc/**/*.md'
    branches: [main, master]
  
  workflow_dispatch:
    inputs:
      scope:
        description: 'Generate'
        required: true
        default: 'changed'
        type: choice
        options:
          - changed
          - all
          - specific
      files:
        description: 'Specific files (comma-separated, e.g., doc/guide.md,doc/api.md)'
        required: false
        type: string
      watermark:
        description: 'Custom watermark text'
        required: false
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Minimal but sufficient for diff
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-plain-generic
        pip install --quiet PyPDF2 reportlab
    
    - name: Detect files to process
      id: detect
      env:
        EVENT_NAME: ${{ github.event_name }}
        SCOPE: ${{ github.event.inputs.scope }}
        SPECIFIC_FILES: ${{ github.event.inputs.files }}
      run: |
        echo "=== File Detection Debug ==="
        echo "Event: $EVENT_NAME"
        echo "Scope: $SCOPE"
        
        FILES="[]"
        
        if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
          if [ "$SCOPE" = "all" ]; then
            FILES=$(find doc -name "*.md" -type f | jq -R -s -c 'split("\n") | map(select(length > 0))')
          elif [ "$SCOPE" = "specific" ] && [ -n "$SPECIFIC_FILES" ]; then
            FILES=$(echo "$SPECIFIC_FILES" | jq -R -s -c 'split(",") | map(select(length > 0))')
          fi
        else
          # For push events - try multiple diff strategies
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            # Standard approach
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'doc/*.md' 'doc/**/*.md' 2>/dev/null || echo "")
          else
            # Fallback for shallow clones or initial commits
            CHANGED=$(git diff --name-only $(git hash-object -t tree /dev/null) HEAD -- 'doc/*.md' 'doc/**/*.md' 2>/dev/null || echo "")
          fi
          
          if [ -n "$CHANGED" ]; then
            FILES=$(echo "$CHANGED" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
        fi
        
        echo "Files: $FILES"
        echo "files=$FILES" >> $GITHUB_OUTPUT
    
    - name: Generate PDFs
      if: steps.detect.outputs.files != '[]'
      id: generate
      env:
        FILES_JSON: ${{ steps.detect.outputs.files }}
        ACTOR: ${{ github.actor }}
        CUSTOM_WATERMARK: ${{ github.event.inputs.watermark }}
      run: |
        python scripts/generate_pdfs.py
        
    - name: Commit PDFs
      if: steps.generate.outputs.pdf_count != '0'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add doc/**/*.pdf
        git commit -m "ðŸ¤– Auto-generate PDFs (${{ steps.generate.outputs.pdf_count }}) [skip ci]" || echo "No changes"
        git push
