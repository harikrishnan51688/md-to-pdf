name: Generate PDF from Markdown

on:
  # 1. Automatic Trigger on .md file changes
  push:
    paths:
      - 'doc/**/*.md'  # Triggers only when .md files in /doc change [citation:2]
    branches:
      - main  # Or your default branch

  # 2. Manual Trigger with Options
  workflow_dispatch:
    inputs:
      generation_scope:
        description: 'What to generate?'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - specific
      specific_files:
        description: 'Specific .md files (comma-separated, e.g., doc/guide.md, doc/api.md)'
        required: false
        type: string

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to commit the generated PDF back to the repo

    steps:
      - name:  Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetches all history for changed files detection

      - name:  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name:  Install PDF generation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-xetex texlive-fonts-recommended  # LaTeX engine for PDF
          pip install markdown-it-py pandoc  # Markdown to LaTeX/PDF converter

      - name:  Determine Markdown files to process
        id: get_files
        shell: python
        env:
          SCOPE: ${{ github.event.inputs.generation_scope }}
          SPECIFIC: ${{ github.event.inputs.specific_files }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # Python script to determine which .md files to process
          # (Core logic explained in the implementation details below)
          # This script sets the output `files_to_process`

      - name:  Convert Markdown to PDF with Watermark
        id: convert
        env:
          FILES_TO_PROCESS: ${{ steps.get_files.outputs.files_to_process }}
          ACTOR: ${{ github.actor }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp || github.event.created_at }}
        run: |
          # Script to process each file
          # (Core logic explained in the implementation details below)

      - name:  Commit generated PDFs to repository
        if: steps.convert.outputs.files_processed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add doc/**/*.pdf  # Add all new PDFs
          git commit -m "Auto-generated PDF(s) from Markdown [skip ci]" || echo "No changes to commit"
          git push
